# Как работать с сущностями

[![](http://img.youtube.com/vi/Aa6xb2l7e8M/0.jpg)](http://www.youtube.com/watch?v=Aa6xb2l7e8M "")



## Что это такое?

В модуле товаров это один товар. В модуле фотогалереи это одна фотография.

То есть, это одна единица чего-нибудь.

Чтобы вам с этими элементами можно было работать, для них тоже необходимо создавать классы.

Даже если вы не собираетесь добавлять в них никакого функционала, они все-равно нужны для корректной работы WordpressMVC :)



## 1. Создание класса сущности

Для простых элементов и для страниц отличается базовый класс.

### Для простых элементов

```php
<?php
namespace App\Gallery;

class Entity extends \App\BaseEntity {

}
```

### Для страниц

```php
<?php
namespace App\Catalog;

class Entity extends \App\BasePage {

}
```



## 2. Методы для переопределения

Часто вы будете оставлять эти классы пустыми. Но будут случаи, когда вы будете добавлять в них функционал.



### Обработка содержимого страницы

Это у страниц. Чтобы когда вы открываете товар, у вас был не просто текст товара. А сформирована целая карточка (с картинкой, ценой, ...).

И все это отображается вместо обычного текста страницы.

Для этого используем метод `getCard`. В котором меняем текст страницы, превращая его в карточку.

```php
public function getCard(&$content)
{
    // Превращаем текст страницы
    // В карточку
    // С помощью шаблона
    $content = wdpro_render_php(

        // Путь к файлу шаблона
        WDPRO_TEMPLATE_PATH
        	.'catalog_card.php',

        // Данные для шаблона
        $this->getData()
    );
}
```



### Обработка данных перед первым сохранением

```php
protected function prepareDataForCreate($data)
{
    // Например:
    $data['created'] = time();

    return $data;
}
```



### Обработка данных перед каждым сохранением

```php
protected function prepareDataForSave($data)
{
    // Например:
    $data['updated'] = time();

    return $data;
}
```



### Обработка данных после загрузки из базы

```php
protected function prepareDataAfterLoad($data)
{
    // Например:
    $data['keysArr'] = explode(',', $data['keys']);

    return $data;
}
```



### Отслеживание изменений

Запускается после того, как сущность сохранилась в базе.

```php
protected function onChange()
{
    // ...
}
```



### Отслеживание удаления

```php
protected function onRemove()
{
    // ...
}
```



## 3. Использование сущностей

### Как получить объект сущности

По id:

```php
$entity = wdpro_object(
    
    // Класс сущности
    Entity::class,

	// ID сущности
    10
);
```

По данным.

Когда у вас есть массив данных из базы и вам надо превратить их в сущность.

```php
$entity = wdpro_object(
    
    // Класс сущности
    Entity::class,

	// Данные сущности
    [
        'id' => 10,
        'image' => '...',
        'text' => '...',
    ]
);
```



### Обновление данных

В этом случае все данные остаются. Вы только меняете `cost`.

```php
$entity->mergeData([
    'cost' => 1200,
]);
```



### Замена данных новыми

В этом случае старые данные удаляются. Рекомендуем вам пользоваться обновлением данных (прерыдущий пункт). То есть в этом случае в данных сущности останется только `cost`.  А остальные исчезнут.

```php
$entity->setData([
    'cost'=>1200,
]);
```



### Сохранение

```php
$entity->save();
```

или

```php
$entity->mergeData([
    'cost' => 1200,
])->save();
```



### Получить данные сущности

Сразу весь массив данных

```php
$entity->getData();
```

Только один элемент данных

```php
$entity->getData('cost');
```



### Проверить, что сущность новая

Возвращает true, если сущности еще нет в базе

```php
if ($entity->isNew()) {
    // ...
}
```



### Получить  id

```php
$entityId = $entity->id();
```



### Удалить сущность

```php
$entity->remove();
```



### Проверить адрес

Когда это страница.

Относительный

```php
if ($entity->isUri('contacts')) {}
```

Абсолютный

```php
if ($entity->isUrl('http://...')) {}
```

