# Myslq таблицы

[![](http://img.youtube.com/vi/PmuaebpZ4zU/0.jpg)](http://www.youtube.com/watch?v=PmuaebpZ4zU "")

[TOC]

Таблицы в WordpressMVC сделаны так, чтобы их структура редактировалась прямо из кода.

То есть, вы создаете класс таблицы. И прямо в этом классе прописываете структуру таблицы. Что-то поменяли в структуре - поменялось и в самой базе.

Это особенно удобно, когда вам надо внести изменения не только на своем компьютере. Но еще и на сервере. Или может у напарника. Тогда WordpressMVC делает все сам.



## Как создать таблицу

Обычно на один модуль приходится одна таблица. Но вы их можете в модуле создавать сколько угодно.

Давайте разберем, как создать основную таблицу модуля.

Например, если это модуль фотогалереи, вам нужна таблица для фотографий.

```php
<?php
namespace App\Gallery;

class SqlTable extends \App\BaseSqlTable {

	// Название таблицы
	protected static $name = 'app_gallery';

	// Структура таблицы
	protected static function structure() {

		return [

			// Поля таблицы
			static::COLLS => [
				'id',

				// ID страницы,
				// куда добавляются фотографии
				'post_parent'=>'int',

				// Поле для сортировки
				'menu_order'=>'int',

				// Файл фотографии
				'image',

				// Описание фотографии
				'text'=>'text',
			],

			// Индексы
			static::INDEX => [
				'post_parent',
			],

			// Тип таблицы
			static::ENGINE => static::INNODB,
		];
	}


}
```



## Рекомендуемые поля для страниц

То есть, когда вы делаете таблицу для чего-то, что открывается как страница. Например, товары.

Они нужны в том числе, чтобы на сайте работало меню.

```php
// Отображать в меню
'in_menu'=>'tinyint',

// Поле сортировки
'menu_order'=>'int',

// Статус страницы (опубликована, скрыта)
'post_status',

// Заголовок страницы
'post_title',

// Адрес страницы
'post_name',
```



## Как указывать поля

В примере выше вы можете увидеть, что у полей есть имя и тип. Слева имя, справа тип.

Типы указываются как при создании таблицы через запрос CREATE...

Примеры типов:

##### id

Просто пишите "id". И получаете числовой идентификатор с AUTO INCREMENT.

```php
'id',
```

##### varchar

```php
'person_name' => 'varchar(255)',
```

Если не указывать длину, то по-умолчанию она будет 255:

```php
'person_name' => 'varchar',
```

На самом деле вы можете вообще не указывать у полей тип. А указывать только имя. Тогда это будет поле **varchar(255)**:

```php
'person_name',
```

##### text

```php
'post_content' => 'text',
```

##### int

```php
'cost' => 'int(11)',
```

Можете не указывать длину, тогда она будет по-умолчанию 11:

```php
'cost' => 'int',
```

##### tinyint

```php
'enable' => 'tinyint(1)',
```

Можете не указывать длину, тогда она по-умолчанию будет 1:

```php
'enable' => 'tinyint',
```

##### json

По-сути это поле типа text. Но оно дает вам возможность хранить массивы и простые объекты.

Это поле необходимо, например, для полей формы, у которых стоит множественный выбор. Когда можно выбрать несколько пунктов в списке или загрузить несколько файлов.

```php
'files' => 'json',
```

То есть, сохраняете в таком поле массив. И потом когда загружаете данные из таблицы, вы получаете тот же самый массив.



## Как использовать таблицу

В большинстве случаев ее просто достаточно создать. И дальше WordpressMVC сам будет ее использовать.

Но иногда необходимо пользоваться таблицами самостоятельно.

Обычно это делается в контроллере.

### INSERT

```php
$createdId = SqlTable::insert([
    'first_name' => 'Иван',
    'last_name' => 'Иванов',
    'color' => 'red',
    'created_time' => time(),
    'admin' => 1,
]);
```

При создании можете указывать не все данные.

### UPDATE

```php
SqlTable::update(

    // Что меняем
    [
        'color' => 'green',
        'admin' => 0,
    ],

    // Где меняем
    [
        'id' => 10,
    ]
);
```

### DELETE

Упрощенный вариант:

```php
SqlTable::delete([ 'id'=> 10 ]);
```

Обычный вариант (о таком where запросе подробнее ниже):

```php
SqlTable::delete([
    'WHERE `id`=%d',
    [10]
]);
```

### SELECT

```php
$list = SqlTable::select(

    // Where
    [
        'WHERE `name`=%s 
			AND `admin`=%d 
			ORDER BY `id`',
        [ 'Иван', 1 ]
    ],

    // Поля
    'id, name'
);
```

### WHERE

**Внимание!**

Во избежание инъекций (взлома) вот так делать не надо, так не безопасно:

```php
'WHERE `name`="'.$name.'"'
```

Иначе взломщики смогут вставить в ваш запрос опасные штуки. И например, получить доступ к приватным данным или просто всё на вашем сайте удалить.

Для того, чтобы злоумылшенники не смогли ставить в ваш WHERE опасный код, необходимо делать WHERE в виде специального массива. В котором сначала идет строка WHERE. А потом данные, которые необходимо вставить.

```php
[
    // Строка WHERE
    'WHERE name=%s AND admin=%d',
    
    // Данные, которые вставляются в WHERE
    // По-очереди
    [ 'Иван', 1 ]
]
```

**%d** - преобразуется в число

**%s** - преобразуется в строку 

Если это просто строка, в которую ничего не вставляется извне. Тогда да, можете делать WHERE просто строкой:

```php
'WHERE admin=1'
```

